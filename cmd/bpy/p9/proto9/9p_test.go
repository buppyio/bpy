package proto9

import (
	"fmt"
	"reflect"
	"testing"
)

type MsgTestCase struct {
	msg  Msg
	data []byte
}

var msgtests = []MsgTestCase{
	{
		msg: &Tversion{
			Ref:         45,
			MessageSize: 9384,
			Version:     "9P2000",
		},
		data: []byte{0x13, 0x0, 0x0, 0x0, 0x64, 0x2d, 0x0, 0xa8, 0x24, 0x0, 0x0, 0x6, 0x0, 0x39, 0x50, 0x32, 0x30, 0x30, 0x30},
	},
	{
		msg: &Tversion{
			Ref:         65535,
			MessageSize: 8192,
			Version:     "9P2000",
		},
		data: []byte{0x13, 0x00, 0x00, 0x00, 0x64, 0xff, 0xff, 0x00, 0x20, 0x00, 0x00, 0x06, 0x00, 0x39, 0x50, 0x32, 0x30, 0x30, 0x30},
	},
	{
		msg: &Rversion{
			Ref:         45,
			MessageSize: 9384,
			Version:     "9P2000",
		},
		data: []byte{0x13, 0x0, 0x0, 0x0, 0x65, 0x2d, 0x0, 0xa8, 0x24, 0x0, 0x0, 0x6, 0x0, 0x39, 0x50, 0x32, 0x30, 0x30, 0x30},
	},

	{
		msg: &Tauth{
			Ref:   45,
			Afid:  1234,
			Uname: "someone",
			Aname: "something",
		},
		data: []byte{0x1f, 0x0, 0x0, 0x0, 0x66, 0x2d, 0x0, 0xd2, 0x4, 0x0, 0x0, 0x7, 0x0, 0x73, 0x6f, 0x6d, 0x65, 0x6f, 0x6e, 0x65, 0x9, 0x0, 0x73, 0x6f, 0x6d, 0x65, 0x74, 0x68, 0x69, 0x6e, 0x67},
	},
	{
		msg: &Rauth{
			Ref:  45,
			Aqid: Qid{Type: 0, Version: 0, Path: 0},
		},
		data: []byte{0x14, 0x0, 0x0, 0x0, 0x67, 0x2d, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0},
	},
	{
		msg: &Rauth{
			Ref:  0x0101,
			Aqid: Qid{Type: 0xff, Version: 0xffffffff, Path: 0xffffffffffffffff},
		},
		data: []byte{0x14, 0x0, 0x0, 0x0, 0x67, 0x01, 0x01, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff},
	},
	{
		msg: &Rerror{
			Ref: 45,
			Err: "something something something",
		},
		data: []byte{0x26, 0x0, 0x0, 0x0, 0x6b, 0x2d, 0x0, 0x1d, 0x0, 0x73, 0x6f, 0x6d, 0x65, 0x74, 0x68, 0x69, 0x6e, 0x67, 0x20, 0x73, 0x6f, 0x6d, 0x65, 0x74, 0x68, 0x69, 0x6e, 0x67, 0x20, 0x73, 0x6f, 0x6d, 0x65, 0x74, 0x68, 0x69, 0x6e, 0x67},
	},
	{
		msg: &Tattach{
			Ref:   45,
			Fid:   35243,
			Afid:  90872354,
			Uname: "",
			Aname: "weee",
		},
		data: []byte{0x17, 0x0, 0x0, 0x0, 0x68, 0x2d, 0x0, 0xab, 0x89, 0x0, 0x0, 0x22, 0x9a, 0x6a, 0x5, 0x0, 0x0, 0x4, 0x0, 0x77, 0x65, 0x65, 0x65},
	},
	{
		msg: &Tattach{
			Ref:   45,
			Fid:   35243,
			Afid:  NOFID,
			Uname: "ac",
			Aname: "we",
		},
		data: []byte{0x17, 0x0, 0x0, 0x0, 0x68, 0x2d, 0x0, 0xab, 0x89, 0x0, 0x0, 0xff, 0xff, 0xff, 0xff, 0x2, 0x0, 0x61, 0x63, 0x2, 0x0, 0x77, 0x65},
	},
	{
		msg: &Rattach{
			Ref: 45,
			Qid: Qid{Type: 0, Version: 0, Path: 0},
		},
		data: []byte{0x14, 0x0, 0x0, 0x0, 0x69, 0x2d, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0},
	},
	{
		msg: &Tflush{
			Ref:    45,
			OldRef: 23453,
		},
		data: []byte{0x9, 0x0, 0x0, 0x0, 0x6c, 0x2d, 0x0, 0x9d, 0x5b},
	},
	{
		msg: &Rflush{
			Ref: 45,
		},
		data: []byte{0x7, 0x0, 0x0, 0x0, 0x6d, 0x2d, 0x0},
	},

	{
		msg: &Twalk{
			Ref:    45,
			Fid:    1234,
			NewFid: 3452345,
			Names: []string{
				"ongo",
				"bongo",
				"filliyonko",
				"megatronko",
			},
		},
		data: []byte{0x36, 0x0, 0x0, 0x0, 0x6e, 0x2d, 0x0, 0xd2, 0x4, 0x0, 0x0, 0xb9, 0xad, 0x34, 0x0, 0x4, 0x0, 0x4, 0x0, 0x6f, 0x6e, 0x67, 0x6f, 0x5, 0x0, 0x62, 0x6f, 0x6e, 0x67, 0x6f, 0xa, 0x0, 0x66, 0x69, 0x6c, 0x6c, 0x69, 0x79, 0x6f, 0x6e, 0x6b, 0x6f, 0xa, 0x0, 0x6d, 0x65, 0x67, 0x61, 0x74, 0x72, 0x6f, 0x6e, 0x6b, 0x6f},
	},
	{
		msg: &Rwalk{
			Ref: 45,
			Qids: []Qid{
				Qid{Type: 0, Version: 0, Path: 0},
			},
		},
		data: []byte{0x16, 0x0, 0x0, 0x0, 0x6f, 0x2d, 0x0, 0x1, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0},
	},
	{
		msg: &Topen{
			Ref:  45,
			Fid:  21343,
			Mode: 4,
		},
		data: []byte{0xc, 0x0, 0x0, 0x0, 0x70, 0x2d, 0x0, 0x5f, 0x53, 0x0, 0x0, 0x4},
	},

	{
		msg: &Ropen{
			Ref:    45,
			Qid:    Qid{Type: 0, Version: 0, Path: 0},
			Iounit: 1234123,
		},
		data: []byte{0x18, 0x0, 0x0, 0x0, 0x71, 0x2d, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0xcb, 0xd4, 0x12, 0x0},
	},

	{
		msg: &Tcreate{
			Ref:  45,
			Fid:  12343,
			Name: "wakakaaka",
			Perm: DMDIR,
			Mode: 4,
		},
		data: []byte{0x1b, 0x0, 0x0, 0x0, 0x72, 0x2d, 0x0, 0x37, 0x30, 0x0, 0x0, 0x9, 0x0, 0x77, 0x61, 0x6b, 0x61, 0x6b, 0x61, 0x61, 0x6b, 0x61, 0x0, 0x0, 0x0, 0x80, 0x4},
	},
	{
		msg: &Rcreate{
			Ref:    45,
			Qid:    Qid{Type: 0, Version: 0, Path: 0},
			Iounit: 1234123,
		},
		data: []byte{0x18, 0x0, 0x0, 0x0, 0x73, 0x2d, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0xcb, 0xd4, 0x12, 0x0},
	},
	{
		msg: &Tread{
			Ref:    45,
			Fid:    5343,
			Offset: 359842382234,
			Count:  23423,
		},
		data: []byte{0x17, 0x0, 0x0, 0x0, 0x74, 0x2d, 0x0, 0xdf, 0x14, 0x0, 0x0, 0x9a, 0x1, 0x47, 0xc8, 0x53, 0x0, 0x0, 0x0, 0x7f, 0x5b, 0x0, 0x0},
	},

	{
		msg: &Rread{
			Ref:  45,
			Data: []byte("ooooh nooo it's full of data"),
		},
		data: []byte{0x27, 0x0, 0x0, 0x0, 0x75, 0x2d, 0x0, 0x1c, 0x0, 0x0, 0x0, 0x6f, 0x6f, 0x6f, 0x6f, 0x68, 0x20, 0x6e, 0x6f, 0x6f, 0x6f, 0x20, 0x69, 0x74, 0x27, 0x73, 0x20, 0x66, 0x75, 0x6c, 0x6c, 0x20, 0x6f, 0x66, 0x20, 0x64, 0x61, 0x74, 0x61},
	},

	{
		msg: &Twrite{
			Ref:    45,
			Fid:    254334,
			Offset: 21304978234,
			Data:   []byte("something to write"),
		},
		data: []byte{0x29, 0x0, 0x0, 0x0, 0x76, 0x2d, 0x0, 0x7e, 0xe1, 0x3, 0x0, 0x3a, 0x2b, 0xe0, 0xf5, 0x4, 0x0, 0x0, 0x0, 0x12, 0x0, 0x0, 0x0, 0x73, 0x6f, 0x6d, 0x65, 0x74, 0x68, 0x69, 0x6e, 0x67, 0x20, 0x74, 0x6f, 0x20, 0x77, 0x72, 0x69, 0x74, 0x65},
	},
	{
		msg: &Rwrite{
			Ref:   45,
			Count: 12,
		},
		data: []byte{0xb, 0x0, 0x0, 0x0, 0x77, 0x2d, 0x0, 0xc, 0x0, 0x0, 0x0},
	},
	{
		msg: &Tclunk{
			Ref: 45,
			Fid: 23123,
		},
		data: []byte{0xb, 0x0, 0x0, 0x0, 0x78, 0x2d, 0x0, 0x53, 0x5a, 0x0, 0x0},
	},
	{
		msg: &Rclunk{
			Ref: 45,
		},
		data: []byte{0x7, 0x0, 0x0, 0x0, 0x79, 0x2d, 0x0},
	},
	{
		msg: &Tremove{
			Ref: 45,
			Fid: 1234,
		},
		data: []byte{0xb, 0x0, 0x0, 0x0, 0x7a, 0x2d, 0x0, 0xd2, 0x4, 0x0, 0x0},
	},
	{
		msg: &Rremove{
			Ref: 45,
		},
		data: []byte{0x7, 0x0, 0x0, 0x0, 0x7b, 0x2d, 0x0},
	},

	{
		msg: &Tstat{
			Ref: 45,
			Fid: 12341234,
		},
		data: []byte{0xb, 0x0, 0x0, 0x0, 0x7c, 0x2d, 0x0, 0xf2, 0x4f, 0xbc, 0x0},
	},
	{
		msg: &Rstat{
			Ref: 45,
			Stat: Stat{
				Type:   0,
				Dev:    0,
				Qid:    Qid{Type: 0, Version: 0, Path: 0},
				Mode:   0,
				Atime:  0,
				Mtime:  0,
				Length: 0,
				Name:   "",
				UID:    "",
				GID:    "",
				MUID:   "",
			},
		},
		data: []byte{0x3a, 0x0, 0x0, 0x0, 0x7d, 0x2d, 0x0, 0x31, 0x0, 0x2f, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0},
	},
	{
		msg: &Rstat{
			Ref: 45,
			Stat: Stat{
				Type:   0xffff,
				Dev:    0xffffffff,
				Qid:    Qid{Type: 0xff, Version: 0xffffffff, Path: 0xffffffffffffffff},
				Mode:   0xffffffff,
				Atime:  0xffffffff,
				Mtime:  0xffffffff,
				Length: 0xffffffffffffffff,
				Name:   "x",
				UID:    "x",
				GID:    "x",
				MUID:   "x",
			},
		},
		data: []byte{0x3e, 0x0, 0x0, 0x0, 0x7d, 0x2d, 0x0, 0x35, 0x0, 0x33, 0x00, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x1, 0x0, 0x78, 0x1, 0x0, 0x78, 0x1, 0x0, 0x78, 0x1, 0x0, 0x78},
	},

	{
		msg: &Twstat{
			Ref: 45,
			Fid: 12342134,
			Stat: Stat{
				Type:   0,
				Dev:    0,
				Qid:    Qid{Type: 0, Version: 0, Path: 0},
				Mode:   0,
				Atime:  0,
				Mtime:  0,
				Length: 0,
				Name:   "",
				UID:    "",
				GID:    "",
				MUID:   "",
			},
		},
		data: []byte{0x3e, 0x0, 0x0, 0x0, 0x7e, 0x2d, 0x0, 0x76, 0x53, 0xbc, 0x0, 0x31, 0x0, 0x2f, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0},
	},

	{
		msg: &Rwstat{
			Ref: 45,
		},
		data: []byte{0x7, 0x0, 0x0, 0x0, 0x7f, 0x2d, 0x0},
	},
}

func TestPackUnpack(t *testing.T) {
	for _, tc := range msgtests {
		l := tc.msg.WireLen()
		if l != len(tc.data) {
			fmt.Printf("wirelen=%d\nbuflen=%d\n", l, len(tc.data))
			t.Fatal("WireLen incorrect")
		}
		buf := make([]byte, l, l)
		PackMsg(buf, tc.msg)
		if !reflect.DeepEqual(buf, tc.data) {
			fmt.Printf("msg=%#v\nexp=%v\ngot=%v\n", tc.msg, tc.data, buf)
			t.Fatal("Pack incorrect")
		}
		unpacked, err := UnpackMsg(tc.data)
		if err != nil {
			t.Fatal(err)
		}
		if !reflect.DeepEqual(tc.msg, unpacked) {
			fmt.Printf("exp=%#v\ngot=%#v\n", tc.msg, unpacked)
			t.Fatal("Unpack incorrect")
		}
	}
}
